% clear;
close all;
clc;
n = 100;
hfe = (2*pi/n)*ones(1,n+3);
a = [1,0,0,0;0,1,0,0;-3,-2,3,-1;2,1,-2,1];
H = [1,-3,3,-1;...
    4,0,-6,3;...
    1,3,3,-3;...
    0,0,0,1];
Y0 = [420,210,140,105;...
    210,140,105,84;...
    140,105,84,70;...
    105,84,70,60];
Y1 = [420,280,210,168;...
    280,210,168,140;...
    210,168,140,120;...
    168,140,120,105];
Y02 = [0,0,0,0;...
    0,30,30,30;...
    0,30,40,45;...
    0,30,45,54];
Y12 = [0,0,0,0;...
    0,30,40,45;...
    0,40,60,72;...
    0,45,72,90];
p = -1;
q = 1;

K0 = H*Y1*H';
K1 = H*Y12*H';
D0 = zeros(n+3);
D2 = zeros(n+3);
for i = 3 : n-3
    h = diag(hfe(i-1+2:i+2+2));
    D0(i-1+2:i+2+2,i-1+2:i+2+2) = D0(i-1+2:i+2+2,i-1+2:i+2+2) + h*K0*h'/6/6/420/2;
    D2(i-1+2:i+2+2,i-1+2:i+2+2) = D2(i-1+2:i+2+2,i-1+2:i+2+2) + h*K1*h'/6/6/30/2;
end
    
% i = 2, 2h < x < 3h
H2 = [1,-3,3,-1;12,0,-18,9;3,9,9,-9;0,0,0,3];
h = diag(hfe(3:6));
D0(3:6,3:6) = D0(3:6,3:6) + ...
    h*H2*Y1*H2'*h'/18/18/420/2;
D2(3:6,3:6) = D2(3:6,3:6) + ...
    h*H2*Y12*H2'*h'/18/18/30/2;

% i = 1, h < x < 2h
H1 = [3,-9,9,-3;7,3,-15,7;6,18,18,-18;0,0,0,6];
h = diag(hfe(2:5));
D0(2:5,2:5) = D0(2:5,2:5) + ...
    h*H1*Y1*H1'*h'/36/36/420/2;
D2(2:5,2:5) = D2(2:5,2:5) + ...
    h*H1*Y12*H1'*h'/36/36/30/2;

% i = 0, 0 < x < h
H0 = [36,-108,108,-36;0,36,-54,21;0,0,18,-11;0,0,0,6];
h = diag(hfe(1:4));
D0(1:4,1:4) = D0(1:4,1:4) + ...
    h*H0*Y1*H0'*h'/36/36/420/2;
D2(1:4,1:4) = D2(1:4,1:4) + ...
    h*H0*Y12*H0'*h'/36/36/30/2;

for i = n-2 : n+3
    for j = n-2 : n+3
        D0(i,j) = D0(n+4-i,n+4-j);
        D2(i,j) = D2(n+4-i,n+4-j);
    end
end

F = D0\D2;
[V,D] = eig(F);
d=[];
N = 1000;
x = 0 : 2*pi/N : 2*pi;
yy = zeros(N+1);
for i = 1:n+3
    for j = 1 : N+1
        ix = min(floor(x(j)/hfe(i))+2,N+2);
        yx = x(j)/hfe(i)+2-ix;
        if ix>4 && ix<n-1

            yy(i,j) = V(ix-1,i)*phi(4,yx+1) +...
                    V(ix,i)*phi(3,yx) + ...
                    V(ix+1,i)*phi(2,yx-1)+ ...
                    V(ix+2,i)*phi(1,yx-2);
        elseif ix == 4
            yx0 = x(j)/hfe(i);
            yy(i,j) = V(3,i)*(-yx0 + 3)^3/18 + ...
                    V(4,i)*phi(3,yx) + ...
                    V(5,i)*phi(2,yx-1)+ ...
                    V(6,i)*phi(1,yx-2);
        elseif ix == 3
            yx0 = x(j)/hfe(i);
            yy(i,j) = V(2,i)*(-yx0 + 2)^3/12 + ...
                    V(3,i)*(-1/2 + 3/2*yx0 - yx0^2 + 7/36*yx0^3)+ ...
                    V(4,i)*phi(2,yx-1)+ ...
                    V(5,i)*phi(1,yx-2);
        elseif ix == 2
            yx0 = x(j)/hfe(i);
            yy(i,j) = V(1,i)*(-yx0 + 1)^3 + ...
                    V(2,i)*(yx0 - 3/2*yx0^2 + 7/12*yx0^3) + ...
                    V(3,i)*(1/2*yx0^2-11/36*yx0^3) + ...
                    V(4,i)*phi(1,yx-2);
        elseif ix == n-1
            yx0 = n - x(j)/hfe(i);
            yy(i,j) = V(n+1,i)*(-yx0 + 3)^3/18 + ...
                    V(n-2,i)*phi(4,yx+1) + ...
                    V(n-1,i)*phi(3,yx)+ ...
                    V(n,i)*phi(2,yx-1);
        elseif ix == n
            yx0 = n - x(j)/hfe(i);
            yy(i,j) = V(n+2,i)*(-yx0 + 2)^3/12 + ...
                    V(n+1,i)*(-1/2 + 3/2*yx0 - yx0^2 + 7/36*yx0^3) + ...
                    V(n-1,i)*phi(4,yx+1)+ ...
                    V(n,i)*phi(3,yx);
        elseif ix == n+1
            yx0 = n - x(j)/hfe(i);
            yy(i,j) = V(n+3,i)*(-yx0 + 1)^3 + ...
                    V(n+2,i)*(yx0 - 3/2*yx0^2 + 7/12*yx0^3) + ...
                    V(n+1,i)*(1/2*yx0^2-11/36*yx0^3) + ...
                    V(n,i)*phi(4,yx+1);
        end
    end
end
figure;
plot(real(sort(diag(sqrt(real(D))))),'o');
for i = 1 : 5 : n+1
    figure;
    plot(x,yy(i,:));
end